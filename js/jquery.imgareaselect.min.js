/*
 * imgAreaSelect jQuery plugin
 * version 1.0.0-rc.1
 *
 * Copyright (c) 2008-2013 Michal Wojciechowski (odyniec.net)
 *
 * Dual licensed under the MIT (http://opensource.org/licenses/MIT)
 * and GPL (http://opensource.org/licenses/GPL-2.0) licenses.
 *
 * http://odyniec.net/projects/imgareaselect/
 *
 */
 
 /*
 * Fixed to support mobile browsers and scrollable pages
 * Copyright (c) 2016 Javenosa
 */
!function (a) { function f() { return a("<div/>") } var b = Math.abs, c = Math.max, d = Math.min, e = Math.round; a.imgAreaSelect = function (g, h) { function Z(a) { return a + r.left - v.left - document.body.scrollLeft } function $(a) { return a + r.top - v.top - document.body.scrollTop } function _(a) { return a - r.left + v.left + document.body.scrollLeft } function aa(a) { return a - r.top + v.top + document.body.scrollTop } function ba(a) { var c, b = da(a) || a; if (c = parseInt(b.pageX)) return c - v.left - document.body.scrollLeft } function ca(a) { var c, b = da(a) || a; if (c = parseInt(b.pageY)) return c - v.top - document.body.scrollTop } function da(a) { var b = a.originalEvent || {}; return !(!b.touches || !b.touches.length) && b.touches[0] } function ea(a) { var b = a || C, c = a || D; return { x1: e(P.x1 * b), y1: e(P.y1 * c), x2: e(P.x2 * b) - 1, y2: e(P.y2 * c) - 1, width: e(P.x2 * b) - e(P.x1 * b), height: e(P.y2 * c) - e(P.y1 * c) } } function fa(a, b, c, d, f) { var g = f || C, h = f || D; P = { x1: e(a / g || 0), y1: e(b / h || 0), x2: e(++c / g || 0), y2: e(++d / h || 0) }, P.width = P.x2 - P.x1, P.height = P.y2 - P.y1 } function ga() { j && i.width() && (r = { left: e(i.offset().left), top: e(i.offset().top) }, s = i.innerWidth(), t = i.innerHeight(), r.top += i.outerHeight() - t >> 1, r.left += i.outerWidth() - s >> 1, F = e(h.minWidth / C) || 0, G = e(h.minHeight / D) || 0, H = e(d(h.maxWidth / C || 1 << 24, s)), I = e(d(h.maxHeight / D || 1 << 24, t)), v = "fixed" == x ? { left: a(document).scrollLeft(), top: a(document).scrollTop() } : /static|^$/.test(u.css("position")) ? { left: 0, top: 0 } : { left: e(u.offset().left) - u.scrollLeft(), top: e(u.offset().top) - u.scrollTop() }, p = Z(0), q = $(0), (P.x2 > s || P.y2 > t) && qa()) } function ha(b) { if (K) { switch (k.css({ left: Z(P.x1), top: $(P.y1) }).add(l).width(W = P.width).height(X = P.height), l.add(m).add(o).css({ left: 0, top: 0 }), m.add(n).width(c(W - m.outerWidth() + m.innerWidth(), 0)).height(c(X - m.outerHeight() + m.innerHeight(), 0)), n.css({ left: p, top: q, width: W, height: X, borderStyle: "solid", borderWidth: P.y1 + "px " + (s - P.x2) + "px " + (t - P.y2) + "px " + P.x1 + "px" }), W -= o.outerWidth(), X -= o.outerHeight(), o.length) { case 8: a(o[4]).css({ left: W >> 1 }), a(o[5]).css({ left: W, top: X >> 1 }), a(o[6]).css({ left: W >> 1, top: X }), a(o[7]).css({ top: X >> 1 }); case 4: o.slice(1, 3).css({ left: W }), o.slice(2, 4).css({ top: X }) } b !== !1 && (a.imgAreaSelect.keyPress != Aa && a(document).unbind(a.imgAreaSelect.keyPress, a.imgAreaSelect.onKeyPress), h.keys && a(document)[a.imgAreaSelect.keyPress](a.imgAreaSelect.onKeyPress = Aa)) } } function ia(a) { ga(), ha(a), L = Z(P.x1), M = $(P.y1), N = Z(P.x2), O = $(P.y2) } function ja(a, b) { h.fadeDuration ? a.fadeOut(h.fadeDuration, b) : a.hide() } function ka(a) { return R && !/^touch/.test(a.type) } function la(a) { var b = _(ba(a)) - P.x1, c = aa(ca(a)) - P.y1; E = "", h.resizable && (c <= h.resizeMargin ? E = "n" : c >= P.height - h.resizeMargin && (E = "s"), b <= h.resizeMargin ? E += "w" : b >= P.width - h.resizeMargin && (E += "e")), k.css("cursor", E ? E + "-resize" : h.movable ? "move" : "") } function ma(a) { ka(a) || (Y || (ga(), Y = !0, k.one("mouseout", function () { Y = !1 })), la(a)) } function na(b) { R = !1, a("body").css("cursor", ""), (h.autoHide || P.width * P.height == 0) && ja(k.add(n), function () { a(this).hide() }), a(document).off("mousemove touchmove", sa), k.on("mousemove touchmove", ma), b && h.onSelectEnd(g, ea()) } function oa(b) { return ("mousedown" != b.type || 1 == b.which) && ("touchstart" == b.type && (R && na(), R = !0, la(b)), ga(), E ? (L = Z(P["x" + (1 + /w/.test(E))]), M = $(P["y" + (1 + /n/.test(E))]), N = Z(P["x" + (1 + !/w/.test(E))]), O = $(P["y" + (1 + !/n/.test(E))]), A = N - ba(b), B = O - ca(b), a(document).on("mousemove touchmove", sa).one("mouseup touchend", na), k.off("mousemove touchmove", ma)) : h.movable ? (y = p + P.x1 - ba(b), z = q + P.y1 - ca(b), k.off("mousemove touchmove", ma), a(document).on("mousemove touchmove", ua).one("mouseup touchend", function () { R = !1, h.onSelectEnd(g, ea()), a(document).off("mousemove touchmove", ua), k.on("mousemove touchmove", ma) })) : i.mousedown(b), !1) } function pa(a) { J && (a ? (N = c(p, d(p + s, L + b(O - M) * J * (N > L || -1))), O = e(c(q, d(q + t, M + b(N - L) / J * (O > M || -1)))), N = e(N)) : (O = c(q, d(q + t, M + b(N - L) / J * (O > M || -1))), N = e(c(p, d(p + s, L + b(O - M) * J * (N > L || -1)))), O = e(O))) } function qa() { L = d(L, p + s), M = d(M, q + t), b(N - L) < F && (N = L - F * (N < L || -1), N < p ? L = p + F : N > p + s && (L = p + s - F)), b(O - M) < G && (O = M - G * (O < M || -1), O < q ? M = q + G : O > q + t && (M = q + t - G)), N = c(p, d(N, p + s)), O = c(q, d(O, q + t)), pa(b(N - L) < b(O - M) * J), b(N - L) > H && (N = L - H * (N < L || -1), pa()), b(O - M) > I && (O = M - I * (O < M || -1), pa(!0)), P = { x1: _(d(L, N)), x2: _(c(L, N)), y1: aa(d(M, O)), y2: aa(c(M, O)), width: b(N - L), height: b(O - M) } } function ra() { qa(), ha(), h.onSelectChange(g, ea()) } function sa(a) { if (!ka(a)) return qa(), N = /w|e|^$/.test(E) || J ? ba(a) + A : Z(P.x2), O = /n|s|^$/.test(E) || J ? ca(a) + B : $(P.y2), ra(), !1 } function ta(b, c) { N = (L = b) + P.width, O = (M = c) + P.height, a.extend(P, { x1: _(L), y1: aa(M), x2: _(N), y2: aa(O) }), ha(), h.onSelectChange(g, ea()) } function ua(a) { if (!ka(a)) return L = c(p, d(y + ba(a), p + s - P.width)), M = c(q, d(z + ca(a), q + t - P.height)), ta(L, M), a.preventDefault(), !1 } function va() { a(document).off("mousemove touchmove", va), ga(), N = L, O = M, ra(), E = "", n.is(":visible") || k.add(n).hide().fadeIn(h.fadeDuration || 0), K = !0, a(document).off("mouseup touchend", wa).on("mousemove touchmove", sa).one("mouseup touchend", na), k.off("mousemove touchmove", ma), h.onSelectStart(g, ea()) } function wa() { a(document).off("mousemove touchmove", va).off("mouseup touchend", wa), ja(k.add(n)), fa(_(L), aa(M), _(L), aa(M)), this instanceof a.imgAreaSelect || (h.onSelectChange(g, ea()), h.onSelectEnd(g, ea())) } function xa(b) { return !("mousedown" == b.type && 1 != b.which || n.is(":animated")) && (R = "touchstart" == b.type, ga(), y = L = ba(b), z = M = ca(b), A = B = 0, a(document).on({ "mousemove touchmove": va, "mouseup touchend": wa }), !1) } function ya() { ia(!1) } function za() { j = !0, Ba(h = a.extend({ classPrefix: "imgareaselect", movable: !0, parent: "body", resizable: !0, resizeMargin: 10, onInit: function () { }, onSelectStart: function () { }, onSelectChange: function () { }, onSelectEnd: function () { } }, h)), h.show && (K = !0, ga(), ha(), k.add(n).hide().fadeIn(h.fadeDuration || 0)), setTimeout(function () { h.onInit(g, ea()) }, 0) } function Ba(b) { if (b.parent && (u = a(b.parent)).append(k).append(n), a.extend(h, b), ga(), null != b.handles) { for (o.remove(), o = a([]), U = b.handles ? "corners" == b.handles ? 4 : 8 : 0; U--;) o = o.add(f()); o.addClass(h.classPrefix + "-handle").css({ position: "absolute", fontSize: 0, zIndex: w + 1 || 1 }), !parseInt(o.css("width")) >= 0 && o.width(5).height(5) } for (C = h.imageWidth / s || 1, D = h.imageHeight / t || 1, null != b.x1 && (fa(b.x1, b.y1, b.x2, b.y2), b.show = !b.hide), b.keys && (h.keys = a.extend({ shift: 1, ctrl: "resize" }, b.keys)), n.addClass(h.classPrefix + "-outer"), l.addClass(h.classPrefix + "-selection"), U = 0; U++ < 4;) a(m[U - 1]).addClass(h.classPrefix + "-border" + U); k.append(l.add(m)).append(o), Ca && ((V = (n.css("filter") || "").match(/opacity=(\d+)/)) && n.css("opacity", V[1] / 100), (V = (m.css("filter") || "").match(/opacity=(\d+)/)) && m.css("opacity", V[1] / 100)), b.hide ? ja(k.add(n)) : b.show && j && (K = !0, k.add(n).fadeIn(h.fadeDuration || 0), ia()), J = (T = (h.aspectRatio || "").split(/:/))[0] / T[1], i.add(n).off("mousedown touchstart", xa), h.disable || h.enable === !1 ? (k.off({ "mousemove touchmove": ma, "mousedown touchstart": oa }), a(window).off("resize", ya)) : ((h.enable || h.disable === !1) && ((h.resizable || h.movable) && k.on({ "mousemove touchmove": ma, "mousedown touchstart": oa }), a(window).resize(ya)), h.persistent || i.add(n).on("mousedown touchstart", xa)), h.enable = h.disable = void 0 } var j, p, q, s, t, u, y, z, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, R, S, T, U, V, W, X, Y, i = a(g), k = f(), l = f(), m = f().add(f()).add(f()).add(f()), n = f(), o = a([]), r = { left: 0, top: 0 }, v = { left: 0, top: 0 }, w = 0, x = "absolute", P = { x1: 0, y1: 0, x2: 0, y2: 0, width: 0, height: 0 }, Q = navigator.userAgent, Aa = function (a) { var e, f, b = h.keys, g = a.keyCode; if (e = isNaN(b.alt) || !a.altKey && !a.originalEvent.altKey ? !isNaN(b.ctrl) && a.ctrlKey ? b.ctrl : !isNaN(b.shift) && a.shiftKey ? b.shift : isNaN(b.arrows) ? 10 : b.arrows : b.alt, "resize" == b.arrows || "resize" == b.shift && a.shiftKey || "resize" == b.ctrl && a.ctrlKey || "resize" == b.alt && (a.altKey || a.originalEvent.altKey)) { switch (g) { case 37: e = -e; case 39: f = c(L, N), L = d(L, N), N = c(f + e, L), pa(); break; case 38: e = -e; case 40: f = c(M, O), M = d(M, O), O = c(f + e, M), pa(!0); break; default: return } ra() } else switch (L = d(L, N), M = d(M, O), g) { case 37: ta(c(L - e, p), M); break; case 38: ta(L, c(M - e, q)); break; case 39: ta(L + d(e, s - _(N)), M); break; case 40: ta(L, M + d(e, t - aa(O))); break; default: return } return !1 }; this.remove = function () { Ba({ disable: !0 }), k.add(n).remove() }, this.getOptions = function () { return h }, this.setOptions = Ba, this.getSelection = ea, this.setSelection = fa, this.cancelSelection = wa, this.update = ia; var Ca = (/msie ([\w.]+)/i.exec(Q) || [])[1], Da = /webkit/i.test(Q) && !/chrome/i.test(Q); for (S = i; S.length;) w = c(w, isNaN(S.css("z-index")) ? w : S.css("z-index")), h.parent || "fixed" != S.css("position") || (x = "fixed"), S = S.parent(":not(body)"); w = h.zIndex || w, a.imgAreaSelect.keyPress = Ca || Da ? "keydown" : "keypress", k.add(n).hide().css({ position: x, overflow: "hidden", zIndex: w || "0" }), k.css({ zIndex: w + 2 || 2 }), l.add(m).css({ position: "absolute", fontSize: 0 }), g.complete || "complete" == g.readyState || !i.is("img") ? za() : i.one("load", za), !j && Ca && Ca >= 7 && (g.src = g.src) }, a.fn.imgAreaSelect = function (b) { return b = b || {}, this.each(function () { a(this).data("imgAreaSelect") ? b.remove ? (a(this).data("imgAreaSelect").remove(), a(this).removeData("imgAreaSelect")) : a(this).data("imgAreaSelect").setOptions(b) : b.remove || (void 0 === b.enable && void 0 === b.disable && (b.enable = !0), a(this).data("imgAreaSelect", new a.imgAreaSelect(this, b))) }), b.instance ? a(this).data("imgAreaSelect") : this } }(jQuery);